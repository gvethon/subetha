<html>
	<head>
		<title>SubEtha and Your Mail Transport Agent</title>
		
		<style type="text/css">
			/* <![CDATA[ */ 
			@import "http://www.tigris.org/branding/css/tigris.css"; 
			@import "http://www.tigris.org/branding/css/inst.css"; 
			/*  ]]> */
		</style>
		<link rel="stylesheet" type="text/css" href="http://www.tigris.org/branding/css/print.css" media="print" />
		<script src="http://www.tigris.org/branding/scripts/tigris.js" type="text/javascript">
		</script>
	</head>

	<body>
		<h1>SubEtha and your Mail Transport Agent</h1>
		
		<p>
			SubEtha currently requires an external Mail Transport Agent (MTA) to
			actually receive mail from and deliver mail to the internet.  This
			may not be a requirement in the future, we will never ask you
			to replace your favorite MTA.
		</p>
		
		<p>
			You should be able to use any MTA with SubEtha, but the integration
			instructions will be different for each.  Since the developers all
			use <a href="http://www.postfix.org">Postfix</a>, that will be the
			easiest and best documented path (for now).
		</p>
		
		<ul>
			<li><a href="#overview">Overview</a></li>
			<li><a href="#postfix">Integrating with Postfix</a></li>
			<li><a href="#sendmail">Integrating with Sendmail</a></li>
			<li><a href="#exim">Integrating with Exim</a></li>
			<li><a href="#qmail">Integrating with Qmail</a></li>
		</ul>
		
		<a name="overview"></a>
		<h2>Overview</h2>
		<p>
			SubEtha is very smart about what to do with any mail that it gets
			hold of.  SubEtha looks at the envelope sender and the envelope
			recipient and figures out the appropriate action.  The only trick
			is getting the mail into the server.  There are two ways this can work:
		</p>
		
		<ul>
			<li>Inject the method from a script</li>
			<li>Relay into SubEtha via SMTP</li>
		</ul>
		
		<p>
			Script injection is similar to how Mailman, Majordomo, EZMLM,
			and other mailing list managers work.  You can directly inject
			a piece of mail by calling a SOAP method or a much simpler
			HTTP inject interface that SubEtha provides.  This works, but
			it's often difficult to configure in MTAs, especially preserving
			the out-of-band sender envelope information.
		</p>
		
		<p>
			The preferred method of injecting mail into SubEtha is to relay
			mail into the server via SMTP.  This is usually trivial to set
			up.  SubEtha has a simple SMTP stack (by default running on port
			2500) which accepts messages and "does the right thing" with whatever
			it receives.  This SMTP stack is not (yet) robust enough to be
			internet-facing, but it will happily speak to your friendly local
			MTA in it's native tongue.
		</p>
		
		<p>
			In either case, your MTA must be instructed WHICH mail should be
			delivered to SubEtha (as opposed to local mailboxes).  The options
			here vary by MTA.
		</p>
		
		<a name="postfix"></a>
		<h2>Postfix</h2>
		<p>
			There are two recommended ways to integrate Postfix with SubEtha.
		</p>
		
		<h3>Postfix Domain Mapping</h3>
		<p>
			The easiest, and perhaps most ham-fisted way of integrating SubEtha
			with Postfix is to tell Postfix to relay all mail for an entire
			subdomain (or multiple subdomains) to SubEtha.  For instance, if you
			are happy having addresses like <em>one@<strong>lists</strong>.subethamail.org</em> and
			<em>two@<strong>lists</strong>.subethamail.org</em>, you can tell
			Postfix to relay all mail for that subdomain to SubEtha.
		</p>
		
		<ol>
			<li>
				<p>
					Edit /etc/postfix/main.cf.  Add these lines:
				</p>
				<pre>transport_maps = hash:/etc/postfix/transport</pre>
				<pre>relay_domains = hash:/etc/postfix/transport</pre>
				<p>
					If you already have an /etc/postfix/transport, you will
					probably need to use something different for relay_domains.
				</p>
			</li>
			<li>
				<p>
					Edit /etc/postfix/transport.  Add this line:
				</p>
				<pre>lists.yourdomain.com          smtp:[127.0.0.1]:2500</pre>
				<p>
					You can have as many domains and subdomains relayed to
					SubEtha as you wish.  Don't forget to set up the appropriate
					MX records in DNS.
				</p>
				<p>
					Note that the destination (in this case 127.0.0.1) must be
					resolvable via DNS (not just /etc/hosts!) or an IP address.
					Placing the address in brackets skips MX record resolution,
					which is highly recommended.
				</p>
			</li>
			<li>
				Run "postmap /etc/postfix/transport".
			</li>
		</ol>
		
		<h3>Postfix User Mapping</h3>
		<p>
			TBD, after we implement the postfix tcp: map provider.
		</p>
		
		<a name="sendmail"></a>
		<h2>Sendmail</h2>
		<p>
			Want to write this?
		</p>
		
		<a name="exim"></a>
		<h2>Exim</h2>
		<p>
		<h3>v4.61</h3>

		This config will create a domain (or subdomain) filter to relay all messages to smtp://localhost:2500. It uses the fake lists.localhost domain to work from. 
		
		Make the following changes to etc/exim.config :

		<h4>Transports Section:</h4>
		<pre>
local_smtp_port_2500:
  driver = smtp
  port = 2500
  allow_localhost = true
  gethostbyname = true
  hosts=localhost
		</pre>
		<p>Notes 
		<ul>
			<li> <p>
			The hosts are resolved using the gethostbyname function so that the system can be resolved from alternate sources like etc/hosts.</p>
			</li>
			<li>
			The special instruction to allow_localhost is added. This is usually not allows to help keep mail-loops under control. :)
			</li>
		</ul>
		</p>
		<h4>Routers Section:</h4>
		<pre>
subetha:
  driver=accept
  domains=lists.localhost
  self=send
  transport=local_smtp_port_2500
  
  no_more
		</pre>
		</p>

		<p>Note: I found while working with Cygwin that every time I changed etc/exim.config file the permissions were changed to my current windows account: <pre>-rwx------+ 1 skot None 31250 May  8 20:48 /etc/exim.conf</pre> This was problematic as exim was setup to run as a service and should have had the following permissions: <pre>-rw-rw-r--+ 1 SYSTEM root 31250 May  8 20:48 /etc/exim.conf</pre>. To fix this problem I had to continuously re-run exim-config, or change the permissions manually.</p>
		
		<a name="qmail"></a>
		<h2>Qmail</h2>
		<p>
			Want to write this?
		</p>
		
	</body>
</html>
