<html>
	<head>
		<title>SubEtha and Your Mail Transport Agent</title>
		
		<style type="text/css">
			/* <![CDATA[ */ 
			@import "http://www.tigris.org/branding/css/tigris.css"; 
			@import "http://www.tigris.org/branding/css/inst.css"; 
			/*  ]]> */
		</style>
		<link rel="stylesheet" type="text/css" href="http://www.tigris.org/branding/css/print.css" media="print" />
		<script src="http://www.tigris.org/branding/scripts/tigris.js" type="text/javascript">
		</script>
	</head>

	<body>
		<h1>SubEtha and your Mail Transport Agent</h1>
		
		<p>
			SubEtha currently requires an external Mail Transport Agent (MTA) to
			actually receive mail from and deliver mail to the internet.  While
			this may not be a requirement in the future, we will never ask you
			to replace your favorite MTA.
		</p>
		
		<p>
			You should be able to use any MTA with SubEtha, but the integration
			instructions will be different for each.
		</p>
		
		<ul>
			<li><a href="#overview">Overview</a></li>
			<li><a href="#postfix">Integrating with Postfix</a></li>
			<li><a href="#sendmail">Integrating with Sendmail</a></li>
			<li><a href="#exim">Integrating with Exim</a></li>
			<li><a href="#qmail">Integrating with Qmail</a></li>
			<li><a href="#exchange">Integrating with Microsoft Exchange</a></li>
		</ul>
		
		<a name="overview"></a>
		<h2>Overview</h2>
		<p>
			SubEtha is very smart about what to do with any mail that it gets
			hold of.  SubEtha looks at the envelope sender and the envelope
			recipient and figures out the appropriate action.  The only trick
			is getting the mail into the server.  There are two ways this can work:
		</p>
		
		<ul>
			<li>Inject the method from a script</li>
			<li>Relay into SubEtha via SMTP (preferred!)</li>
		</ul>
		
		<p>
			Script injection is similar to how Mailman, Majordomo, EZMLM,
			and other mailing list managers work.  You can directly inject
			a piece of mail by calling a SOAP method or a much simpler
			HTTP inject interface that SubEtha provides.  This works, but
			it's often difficult to configure in MTAs, especially preserving
			the out-of-band sender envelope information.
		</p>
		
		<p>
			The preferred method of injecting mail into SubEtha is to relay
			mail into the server via SMTP.  This is usually trivial to set
			up.  SubEtha has it's own SMTP stack (by default running on port
			2500 and can be overridden by the -Dorg.subethamail.smtp.port= system
			property at startup) which accepts messages and "does the right 
			thing" with whatever it receives.
		</p>
		
		<p>
			In either case, your MTA must be instructed <strong>which</strong>
			mail should be delivered to SubEtha (as opposed to local mailboxes).  
			The options here vary by MTA.
		</p>
		
		<a name="postfix"></a>
		<h2>Postfix</h2>
		<p>
			There are three recommended ways to integrate Postfix with SubEtha.
		</p>
		
		<h3>Manual Postfix Mapping</h3>
		<p>
			You can manually specify which addresses Postfix will relay into SubEtha.
			There are two types of addresses you can specify:
		</p>
		<ol>
			<li>Whole domains, such that all addresses for that domain will
			be delivered to SubEtha.  For example, all addresses at the
			domain <em>lists.example.com</em>.</li>
			<li>Full addresses of mailing lists.  You can cherrypick
			specific email addresses, such as <em>announce@example.com</em></li>
		</ol>
		
		<p>
			The steps to configure Postfix:
		</p>
		<ol>
			<li>
				<p>
					Edit /etc/postfix/main.cf.  Change or add these lines:
				</p>
				<pre>mydestination = ... example.com  # add example.com to existing line</pre>
				<pre>transport_maps = hash:/etc/postfix/subetha_transport</pre>
				<pre>local_recipient_maps = proxy:unix:passwd.byname $alias_maps hash:/etc/postfix/subetha_transport</pre>
				<p>
					Note that local_recipient_maps must be defined after alias_maps.
				</p>
			</li>
			<li>
				<p>
					Edit /etc/postfix/subetha_transport.  Add these lines:
				</p>
				<pre>lists.example.com          smtp:[127.0.0.1]:2500</pre>
				<pre>announce@example.com       smtp:[127.0.0.1]:2500</pre>
				<p>
					This example forwards mail destined for any address @lists.example.com
					and mail to the specific address announce@example.com along to
					SubEtha.  You can have as many domains, subdomains, and addresses as you wish.
					Don't forget to set up the appropriate MX records in DNS.
				</p>
				<p>
					Note that the destination (in this case 127.0.0.1) must be
					resolvable via DNS (not just /etc/hosts!) or as an IP address.
					Placing the address in brackets skips MX record resolution,
					which is highly recommended.
				</p>
			</li>
			<li>
				Run "postmap /etc/postfix/subetha_transport".
			</li>
			<li>
				<strong>NOTE:</strong>  To specify full addresses like <em>announce@example.com</em>,
				Postfix <strong>must</strong> be configured to use <strong>-</strong> as the
				user extension separator.  This is not the postfix default.  This configuration
				is unnecessary if whole subdomains (ie lists.example.com) are specified.  It is
				also unnecessary if Automatic Postfix Mapping is used.
			</li>
			<li>
				<strong>ALSO NOTE:</strong>  You must put all domains on which you expect to
				run mailing lists in the <em>mydestination</em> list.
			</li>
		</ol>
		
		<h3>Postfix with a Virtual Host based setup</h3>

		<p>
			This isn't an optimal solution, but postfix doesn't really offer any other way to configure things
			(that we were able to figure out) so that it works with a virtual host setup in postfix.
		</p>

		<p>
			In this case, you have postfix running with your MX records pointing to Server A (takahe.whichever.com). 
			On Server B (subetha.whichever.com), you setup SubEtha Mail SMTP server to listen on port 25 using the 
			-Dorg.subethamail.smtp.port=25 switch during startup (I put it in my JBOSS_HOME/bin/run.conf).
		</p>
		
		<p>
			Postfix main.cf setup as follows:
		</p>
			<pre>
myhostname = takahe.whichever.com
local_recipient_maps=
virtual_alias_maps = hash:/etc/postfix/virtual
			</pre>
			
		<p>
			The virtual file looks like this:
		</p>
			
			<pre>
whichever.com			anything
list@whichever.com		list@subetha.whichever.com
			</pre>

		<p>
			Now, make sure to run 'cd /etc/postfix; postmap virtual'
		</p>
		
		<p>
			In SubEtha, set the list settings to be: list@subetha.whichever.com
		</p>

		<p>
			What this does is that all mail to the list gets forwarded from Server A to Server B. Any bounce emails
			are generated with the reply going directly to the subetha.whichever.com machine.
		</p>

		<h3>Automatic Postfix Mapping</h3>
		<p>
			This is still experimental.  It is, however, very convenient.
		</p>
		<p>
			SubEtha provides correct values for the Postfix transport table through
			an implementation of the <a href="http://www.postfix.org/tcp_table.5.html">Postfix tcp: map 
			provider</a>.  This will automatically work for all addresses that SubEtha
			wants to claim, such as mailing list addresses, mailing list owner addresses,
			and VERPed bounce messages.
		</p>
		
		<p>
			On some systems (OSX), the tcp_table is not compiled in by default. In order to enable it,
			download the latest source, compile and then install postfix over your existing installation.
			Use the command: 'make makefiles CCARGS=-DSNAPSHOT; make; make install' and just answer the
			defaults during install.
		</p>
		
		<p>
			The steps are similar to manual postfix mapping, all configured in main.cf:
		</p>
		<ol>
			<li>Add any relevant domains to <em>mydestination</em>.  Only add whole
			domains, not individual list addresses</li>.
			<li>
				<p>Add these lines:</p>
				<pre>transport_maps = tcp:[127.0.0.1]:2502</pre>
				<pre>local_recipient_maps = proxy:unix:passwd.byname $alias_maps tcp:[127.0.0.1]:2502</pre>
				<p>
					Note that local_recipient_maps must be defined after alias_maps.
				</p>
			</li>
		</ol>
		<p>
			With this approach, /etc/postfix/transport is unnecessary.  Also, the Postfix
			extension delimiter is irrelevant - SubEtha will correctly claim any appropriate
			messages, causing them to be relayed into SubEtha.
		</p>
		
		<a name="sendmail"></a>
		<h2>Sendmail</h2>
		<p>
			<ol>
			<li><p>Add your domain to access file:</p>
			<pre>DOMAIN.COM RELAY</pre></li>
			<li><p>Add a mailertable in mailertable file:</p>
			<pre>DOMAIN.COM smtp:[IP]:PORT</pre></li>
			<li><p>Rehash the files:</p>
			<pre>makemap hash /etc/mail/access < /etc/mail/access</pre>
			<pre>makemap hash /etc/mail/mailertable < /etc/mail/mailertable</pre></li>
			</ol>
		</p>
		
		<a name="exim"></a>
		<h2>Exim</h2>
		<p>
		<h3>v4.61</h3>

		<p>
		This config will create a domain (or subdomain) filter to relay all messages to smtp://localhost:2500. 
		To do this we create a fake email (sub)domain (@lists.localhost) while still allowing local delivery for @localhost addresses. 
		</p>
		
		<p>
		Make the following changes to etc/exim.config :
		</p>
		
		<h4>Transports Section:</h4>
		<pre>
local_smtp_port_2500:
  driver = smtp
  port = 2500
  allow_localhost = true
  gethostbyname = true
  hosts=localhost
		</pre>
		<p><strong>Notes</strong> 
		<ul>
			<li> 
				<p>
					gethostbyname: This resolves hosts using alternate sources like etc/hosts instead of just through dns mx records.
				</p>
			</li>
			<li>
				<p>
				allow_localhost: This is usually not allowed to help keep mail-loops under control. :)  
				Since we are running a totally different mail server on localhost:2500 we have no worries that the message will loop back into the same system.
				</p>
			</li>
		</ul>
		</p>
		<h4>Routers Section:</h4>
		<pre>
subetha:
  driver=accept
  domains=lists.localhost
  self=send
  transport=local_smtp_port_2500
  
  no_more
		</pre>
		</p>

		<p><b>Note:</b> I found while working with Cygwin that every time I changed etc/exim.config file the permissions 
		were changed to my current windows account: <pre>-rwx------+ 1 skot None 31250 May  8 20:48 /etc/exim.conf</pre> 
		This was problematic as exim was setup to run as a service and should have had the following permissions: 
		<pre>-rw-rw-r--+ 1 SYSTEM root 31250 May  8 20:48 /etc/exim.conf</pre>. To fix this problem I had to 
		continuously re-run exim-config, or change the permissions manually.</p>
		
		<a name="qmail"></a>
		<h2>Qmail</h2>
		<p>
			<ol>
			<li><p>Create a file under /var/qmail/control named smtproutes and with the content:</p>
			<pre>domain.com:[IP MACHINE]:PORT</pre>
			
			<p>In my setup, the file looks like:</p>
			<pre>domain.com:[127.0.0.1]:2500</pre></li>
			
			<li>Restart Qmail.</li>
			</ol>
		</p>
		
		<a name="exchange"></a>
		<h2>Microsoft Exchange</h2>
		
<p>
The following instructions were adapted from Microsoft Technical documents
<a href="http://support.microsoft.com/kb/321721/">KB321721</a> and
<a href="http://www.microsoft.com/technet/prodtechnol/exchange/guides/POP3SvcE2k3/fa2007e3-9b6c-4bfa-bab9-5ccb0ca0a3e5.mspx?mfr=true">this one</a>
.  The second one was particularly helpful.
</p>

<p>
You can setup your SubEtha lists to exist publicly on a subdomain (lists.example.com) or have exchange pass through any domain for that matter.
</p>
 
<p>
 Hosting your SubEtha Lists on a (sub)domain (lists.example.com)
</p>
 
<p>
1.) Modify the Default Recipient Policy by adding your subdomain (i.e.
lists.example.com) as a new non-primary address.  Ensure that "This Exchange
Organization is responsible for all mail delivery to this address." is
unchecked for the new address.
</p>
<p>
a.       If prompted to change all address, choose no.
</p>

<p>
2.)     Create a new SMTP Connector choosing "Forward all mail through this
connector to the following smart hosts, providing the IP address of your
SubEtha List Server as the address (i.e. [192.168.1.100])
</p>
<p>
a.       Add your local SMTP Virtual Server as a bridgehead server
</p>
<p>
b.      Select the Address Space tab and add a new SMTP address of your
subdomain (lists.example.com).  You can leave the cost at 1 and ensure that
"Allow messages to be relayed to these domains" is checked.
</p>
<p>
3.)     Modify your SubEtah startup script (run.bat) to set the
org.subethamail.smtp.port property and set it to 25 (i.e.
-Dorg.subethamail.smtp.port=25)
</p>
<p>
a.       Note: this is necessary because you cannot set the outbound port on
the Exchange SMTP connector as far as I can tell.  If anyone knows how to do
this, please share
</p>

<p>
4.)     Restart SubEtha
</p>
 
<p>
You should now be able to send mail to your lists in the form of
mylist@lists.example.com and your Exchange server will relay it to your
SubEtha List Server.
</p>


<h3> 
Sharing your primary domain between Exchange Server and SubEtha
</h3>
<p>
When doing this you will not get all the features included in subetha. 
You will not get support for verp, and related features.
</p>
<p>
This setup still requires that you treat your SubEtha List Server as a
subdomain (lists.example.com), however, to the outside world your lists will
be addressable via your primary domain (example.com)
</p>
 
<p>
1.)     Create a Contact for each list using Active Directory Users and
Computers.  Uncheck "create an Exchange Email Address".
</p>

<p>
a.       Find your newly created Contacts, right-click and choose "Exchange
Tasks." Then choose "Establish Email Address" and then click Modify to add a
new external SMTP address of your full list address (i.e.
subetha-interest@lists.example.com).  Note the use of the subdomain
</p>
<p>
b.      I used a naming scheme for these contacts where I would always give
them an alias ending in "-list".  So, a SubEtha Interest list would be
"subetha-list."  Keep in mind that the alias you give to these contacts will
be the public e-mail address for your lists. In essence, what were doing
here is create an Exchange entry for your list with an email address of
subetha-list@example.com which maps to the real list address of
subetha-interest@lists.example.com.
</p>

<p>
2.)     Add a new Email Addresses Recipient Policy adding your subdomain
address as the primary address and ensuring that for this address "This
Exchange Organization is responsible for all mail delivery to this address."
is unchecked.
</p>

<p>
3.)     Create a new SMTP Connector choosing "Forward all mail through this
connector to the following smart hosts, providing the IP address of your
SubEtha List Server as the address (i.e. [192.168.1.100])
</p>

<p>
a.       Add your local SMTP Virtual Server as a bridgehead server
</p>

<p>
b.      Select the Address Space tab and add a new SMTP address of your
subdomain (lists.example.com).  You can leave the cost at 1 and ensure that
"Allow messages to be relayed to these domains" is checked.
</p>

<p>
4.)     Modify your SubEtah startup script (run.bat) to set the
org.subethamail.smtp.port property and set it to 25 (i.e.
-Dorg.subethamail.smtp.port=25)
</p>

<p>
a.       Note: this is necessary because you cannot set the outbound port on
the Exchange SMTP connector as far as I can tell.  If anyone knows how to do
this, please share
</p>

<p>
5.)     Restart SubEtha
</p>

<p>
6.)     Modify your SubEtha lists to enable the Reply-To filter, unchecking
Mailing List and adding the public address of your list
(subetha@example.com) manually.
</p>

<p>
You should now be able to send mail to your lists in the form of
my-list@example.com and your Exchange server will relay it to your SubEtha
List Server.
</p>

<p>
I'm personally using the second option as I wanted the lists to be on my
primary domain as far as the outside world was concerned.  The first way
also presented a problem as far as our spam filtering service was concerned
so the second way worked out best for us.  The downside in my opinion is
that from an administrative standpoint, creating the Exchange contacts for
each list is just an extra step, but since we have a pretty static
environment, it will probably work out OK.  On a final note, so that our
Exchange users don't have to look at our lists in their address book, I
checked "Hide from Exchange address list."
</p>


	</body>
</html>
