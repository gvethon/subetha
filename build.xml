<?xml version="1.0"?>

<!--
	$Id$
	$URL$

	Top-level build file for SubEtha  Imports build files for the
	various modules, so this is the only entry point.
	
	To run the junit tests, you must copy junit.jar into ANT_HOME/lib.
-->

<project name="subetha" default="appmain-ear" basedir=".">

	<property name="name" value="${ant.project.name}" />
	
	<property file="user.properties" />
	<property file="build.properties" />

	<property name="build.dir" location="build" />
	<property name="build.javadoc.i.dir" location="${build.dir}/api-public" />
	<property name="build.javadoc.all.dir" location="${build.dir}/api-all" />
	
	<property name="build.debug" value="on" />
	<property name="build.deprecation" value="on" />
	
	<!-- Maybe overriden in your user.properties -->
	<property name="deploy.dir" location="${jboss.dir}/server/default/deploy" />

	<!-- Set up a basic path for everyone -->
	<path id="base.classpath">
		<fileset dir="${jboss.dir}">
			<include name="server/default/deploy/**/*.jar"/>
			<include name="server/default/lib/**/*.jar"/>
			<include name="lib/**/*.jar"/>
		</fileset>
		
		<pathelement path="${java.class.path}" />
	</path>
	
	<!-- Common is special because master.classpath depends on it -->
	<import file="common/build.xml"/>
	
	<path id="master.classpath">
		<pathelement location="${build.common.jar.file}" />
		<path refid="common.classpath" />
	</path>
	
	<!-- Now the rest of the imports -->
	<import file="entity/build.xml"/>
	<import file="core/build.xml"/>
	<import file="plugin/build.xml"/>	
	<import file="frontend/build.xml"/>
	<import file="rtest/build.xml"/>
	<import file="loadtest/build.xml"/>
	<import file="appmain/build.xml"/>
	
	<target name="usage"> 
		<echo message="  Execute 'ant -projecthelp' for build file help."/> 
		<echo message="  Execute 'ant -help' for Ant help."/> 
	</target> 
	<target name="help" depends="usage"/>
	
	<target name="init">
		<tstamp/>
		<property name="build.version" value="UNVERSIONED"/>
	</target>
	
	<target name="input-version">
		<input addproperty="build.version" message="Version number?" />
	</target>
	
	<target name="formal-build" depends="clean, input-version, appmain-ear">
	</target>
	
	<target name="formal-deploy" depends="formal-build, deploy">
	</target>
	
	<target name="clean">
		<delete dir="${build.dir}" />
	</target>

	<target name="javadoc-i">
		<mkdir dir="${build.javadoc.i.dir}"/>
		
		<!-- this classpath isn't right -->
		<javadoc
			destdir="${build.javadoc.i.dir}"
			packagenames="*"
			classpathref="frontend.classpath"
			author="true"
			version="true"
		>
			<fileset dir="${common.javasrc.dir}"/>
			
			<fileset dir="${core.javasrc.dir}">
				<include name="**/i/**" />
			</fileset>
		</javadoc>
	</target>
	
	<target name="javadoc-all">
		<mkdir dir="${build.javadoc.all.dir}"/>
		
		<!-- this classpath isn't right -->
		<javadoc
			destdir="${build.javadoc.all.dir}"
			packagenames="*"
			classpathref="frontend.classpath"
			author="true"
			version="true"
		>
			<fileset dir="${common.javasrc.dir}"/>
			<fileset dir="${entity.javasrc.dir}"/>
			<fileset dir="${core.javasrc.dir}"/>
			<fileset dir="${plugin.javasrc.dir}"/>
			<fileset dir="${frontend.javasrc.dir}"/>
			<fileset dir="${rtest.javasrc.dir}"/>
		</javadoc>
	</target>
	
	<target name="deploy" depends="appmain-ear">
		<copy file="${build.appmain.ear.file}" todir="${deploy.dir}" />
	</target>
	
	<target name="cleandeploy" depends="clean, deploy">
	</target>
	
	<target name="touchapp">
		<basename property="build.appmain.ear.basename" file="${build.appmain.ear.file}" />
		<touch file="${deploy.dir}/${build.appmain.ear.basename}" />
	</target>
	
	<target name="dist" depends="input-version, clean, appmain-ear, javadoc-i, javadoc-all">
		<property name="build.dist.dir" location="${build.dir}/${ant.project.name}-${build.version}"/>
		<property name="build.dist.zip" location="${build.dir}/${ant.project.name}-${build.version}.zip"/>

		<basename property="build.javadoc.i.dir.basename" file="${build.javadoc.i.dir}" />
		<basename property="build.javadoc.all.dir.basename" file="${build.javadoc.all.dir}" />
		
		<copy todir="${build.dist.dir}">
			<fileset dir="${build.dir}">
				<include name="${build.javadoc.i.dir.basename}/**" />
				<include name="${build.javadoc.all.dir.basename}/**" />
			</fileset>
			
			<fileset file="${build.appmain.ear.file}"/>
			
			<fileset dir=".">
				<include name="README.html" />
				<include name="LICENSE.txt" />
				<include name="www/**" />
			</fileset>
		</copy>
		
		<dirname property="build.dist.dir.dirname" file="${build.dist.dir}" />
		<basename property="build.dist.dir.basename" file="${build.dist.dir}" />
		
		<zip zipfile="${build.dist.zip}" basedir="${build.dist.dir.dirname}">
			<include name="${build.dist.dir.basename}/**" />
		</zip>
	</target>

</project>

