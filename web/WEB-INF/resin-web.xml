<!--
	$Id:$
	$URL: $
-->

<web-app xmlns="http://caucho.com/ns/resin"
	xmlns:resin="urn:java:com.caucho.resin"
	xmlns:cfg="urn:java:com.caucho.config"
	xmlns:jms="urn:java:com.caucho.jms"
	xmlns:ejb="urn:java:com.caucho.ejb"
	xmlns:adm="urn:java:org.subethamail.core.admin"
	xmlns:auth="urn:java:org.subethamail.core.auth"
	xmlns:ss="urn:java:org.subethamail.web.security"
	xmlns:queue="urn:java:org.subethamail.core.queue"
	xmlns:search="urn:org.subethamail.core.search"
	>
	
<!--	Doesn't work-->
<!-- 	<web-app id="/se"/>-->

 	<statistics-enable/>
 	
	<logger name="com.caucho" level="config" />
	<logger name="com.caucho.hessian" level="finest" />
	<logger name="com.caucho.security" level="finest" />
	
<!--	<logger name="com.caucho.admin" level="severe" />-->
<!--	<logger name="com.caucho.config" level="finest" />-->
<!--	<logger name="com.caucho.config.j2ee" level="finest"/>-->
<!--	<logger name="com.caucho.config.inject" level="finest"/>-->
<!--	<logger name="com.caucho.loader" level="fine" />-->
<!--	<logger name="com.caucho.server" level="fine" />-->

	<logger name="org.subethamail" level="finest" />
	<logger name="org.subethamail.smtp" level="info" />
	<logger name="org.hibernate" level="warning" />


<!--  These (specifically the ResinLogin) seems to cause the injector to find multiple matches. Seems to work just letting the class be found automatically. -->
<!--	
	<ss:ResinLogin/>
	<auth:SubEthaAuthenticator/>
-->

	<resource
		mbean-name="subetha:name=Cleanup"
		type="org.subethamail.core.admin.CleanupBean"
		mbean-interface="org.subethamail.core.admin.CleanupManagement" />

<!--	Disabled for now, maybe a resin bug because it starts once in the Env load, and once in the webapp-->
<!--	<resource-->
<!--		mbean-name="subetha:name=SMTPService"-->
<!--		type="org.subethamail.core.smtp.SMTPService"-->
<!--		mbean-interface="org.subethamail.core.smtp.SMTPManagement" />-->

	<!-- Every night at 4am run cleanup -->
	<resin:ScheduledTask task="#{cleanupBean}">
		<cron>0 4 *</cron>
	</resin:ScheduledTask>

	<!-- Every 5 minutes run the indexer-->
	<resin:ScheduledTask task="#{indexerBean}">
		<cron>5</cron>
	</resin:ScheduledTask>

	<!-- Start now (in a few seconds)-->
	<resin:ScheduledTask task="#{cleanupBean}">
		<resin:delay>10s</resin:delay>
	</resin:ScheduledTask>

	<resin:ScheduledTask task="#{indexerBean}" >
		<resin:delay>20s</resin:delay>
	</resin:ScheduledTask>


	<!-- JMS -->
	<jms:JmsConnectionFactory />

	<jms:MemoryQueue>
		<queue:DeliveryQueue/>
		<Named>delivery</Named>
	</jms:MemoryQueue>

	<jms:MemoryQueue>
		<queue:InjectQueue/>
		<Named>injection</Named>
	</jms:MemoryQueue>

	<ejb-message-bean class="org.subethamail.core.queue.DeliveryListener">
		<destination>#{delivery}</destination>
	</ejb-message-bean>

	<ejb-message-bean class="org.subethamail.core.queue.InjectListener">
		<destination>#{injection}</destination>
	</ejb-message-bean>

	<database jndi-name="jdbc/subetha">
		<ping>true</ping>
		<ping-interval>0</ping-interval>
		<ping-query>select 1;</ping-query>

		<driver type="org.postgresql.Driver">
			<url>jdbc:postgresql://localhost/subetha</url>
			<user>subetha</user>
			<password>subetha</password>
		</driver>
	</database>

	<ejb-server data-source="jdbc/subetha"
		validate-database-schema="true" create-database-schema="true" />

	<mail jndi-name="java:comp/env/outbound-mail">
		<smtp-host>localhost</smtp-host>
		<smtp-port>25</smtp-port>
    </mail>
	
	<servlet-mapping url-pattern="/api/AccountMgr" servlet-class="org.subethamail.core.acct.AccountMgrBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Admin" servlet-class="org.subethamail.core.admin.AdminBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/ListWizard" servlet-class="org.subethamail.core.admin.ListWizardBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Injector" servlet-class="org.subethamail.core.injector.InjectorBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Archiver" servlet-class="org.subethamail.core.list.ArchiverBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/ListMgr" servlet-class="org.subethamail.core.list.ListMgrBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Indexer" servlet-class="org.subethamail.core.search.IndexerBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Plumber" servlet-class="org.subethamail.core.admin.PlumberBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>		
	<servlet-mapping url-pattern="/api/AccountMgr" servlet-class="org.subethamail.core.acct.AccountMgrBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Admin" servlet-class="org.subethamail.core.admin.AdminBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/ListWizard" servlet-class="org.subethamail.core.admin.ListWizardBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Injector" servlet-class="org.subethamail.core.injector.InjectorBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Archiver" servlet-class="org.subethamail.core.list.ArchiverBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/ListMgr" servlet-class="org.subethamail.core.list.ListMgrBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Indexer" servlet-class="org.subethamail.core.search.IndexerBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
	<servlet-mapping url-pattern="/api/Plumber" servlet-class="org.subethamail.core.admin.PlumberBean">
		<protocol uri="hessian:"/>
	</servlet-mapping>
  
</web-app>